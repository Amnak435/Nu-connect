<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Diagnostic Tool</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 2rem;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .status {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }

        .error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }

        code {
            background-color: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }

        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <h1>ü§ñ Gemini Connection Diagnostic</h1>

    <div id="env-status" class="status">
        Checking Environment Variable...
    </div>

    <div id="api-status" class="status" style="display: none;">
        Ready to Test API Connection...
    </div>

    <button id="test-btn" onclick="runTest()">Test Gemini Connection Now</button>

    <div id="logs-container" style="margin-top: 2rem; display: none;">
        <h3>Detailed Logs:</h3>
        <pre id="logs">Waiting for test...</pre>
    </div>

    <script type="module">
        // Access the environment variable injected by Vite/Vercel
        const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

        const envStatusEl = document.getElementById('env-status');
        const apiStatusEl = document.getElementById('api-status');
        const logsEl = document.getElementById('logs');
        const logsContainerEl = document.getElementById('logs-container');

        // Check if Key Exists IMMEDIATELY on load
        if (API_KEY) {
            envStatusEl.className = 'status success';
            envStatusEl.innerHTML = `‚úÖ <strong>VITE_GEMINI_API_KEY Found!</strong><br>Key starts with: <code>${API_KEY.substring(0, 5)}...</code>`;
            apiStatusEl.style.display = 'block';
        } else {
            envStatusEl.className = 'status error';
            envStatusEl.innerHTML = `‚ùå <strong>VITE_GEMINI_API_KEY Missing!</strong><br> The app cannot see the API key. Please check Vercel settings again.`;
            document.getElementById('test-btn').disabled = true;
            document.getElementById('test-btn').innerText = "Cannot Test (Missing Key)";
        }

        window.runTest = async function () {
            logsContainerEl.style.display = 'block';
            addToLog("Starting API Test...");

            if (!API_KEY) {
                addToLog("ERROR: No API Key available. Aborting.");
                return;
            }

            addToLog(`Using Model: gemini-pro`);
            addToLog(`Endpoint: https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=HIDDEN`);

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: "Hello! Reply with 'OK' if you can hear me." }]
                            }]
                        })
                    }
                );

                addToLog(`Response Status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    addToLog(`API ERROR DETAILS:\n${JSON.stringify(errorData, null, 2)}`);
                    apiStatusEl.className = 'status error';
                    apiStatusEl.innerHTML = `‚ùå <strong>API Connection Failed!</strong><br>See logs below for details.`;
                } else {
                    const data = await response.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    addToLog(`SUCCESS! AI Replied:\n"${reply}"`);
                    apiStatusEl.className = 'status success';
                    apiStatusEl.innerHTML = `‚úÖ <strong>API Connected Successfully!</strong><br>AI says: "${reply}"`;
                }

            } catch (err) {
                addToLog(`NETWORK/FETCH ERROR: ${err.message}`);
                apiStatusEl.className = 'status error';
                apiStatusEl.innerHTML = `‚ùå <strong>Network Error!</strong><br>Check your internet connection.`;
            }
        };

        function addToLog(msg) {
            logsEl.textContent += '\n' + msg;
        }
    </script>
</body>

</html>